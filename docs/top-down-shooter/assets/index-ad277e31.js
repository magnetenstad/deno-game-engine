var T=Object.defineProperty;var z=(n,t,e)=>t in n?T(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var r=(n,t,e)=>(z(n,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const h of a.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();const D=(n,t)=>{const e=n.indexOf(t);e>-1&&n.splice(e,1)};class c{constructor(t,e){r(this,"x");r(this,"y");this.x=t,this.y=e}plus(t){return new c(this.x+t.x,this.y+t.y)}minus(t){return new c(this.x-t.x,this.y-t.y)}multiply(t){return new c(this.x*t,this.y*t)}divide(t){return new c(this.x/t,this.y/t)}half(){return this.multiply(.5)}snap(t){return new c(Math.round(this.x/t)*t,Math.round(this.y/t)*t)}lengthTo(t){return Math.sqrt((this.x-t.x)**2+(this.y-t.y)**2)}isInside(t,e){return t.x<=this.x&&this.x<=t.x+e.x&&t.y<=this.y&&this.y<=t.y+e.y}moveTowards(t,e){return this.plus(this.direction(t).multiply(e))}direction(t){if(t.y===this.y&&t.x===this.x)return new c(0,0);const e=Math.atan2(t.y-this.y,t.x-this.x);return new c(Math.cos(e),Math.sin(e))}round(){return new c(Math.round(this.x),Math.round(this.y))}clamp(t,e){return new c(P(this.x,t.x,e.x),P(this.y,t.y,e.y))}equals(t){return this.x===t.x&&this.y==t.y}copy(){return new c(this.x,this.y)}}const P=(n,t,e)=>Math.max(Math.min(n,e),t),A=(n,t)=>n+Math.random()*(t-n),E=(n,t)=>Math.round(A(n,t));var p;(function(n){n[n.Left=0]="Left",n[n.Middle=1]="Middle",n[n.Right=2]="Right",n[n.BrowserBack=3]="BrowserBack",n[n.BrowserForward=4]="BrowserForward"})(p||(p={}));const w=new Set,y=new Set,g=new Set;document.addEventListener("keydown",n=>{w.add(n.key)});document.addEventListener("keyup",n=>{y.add(n.key)});const F=n=>{const t=new Set,e=new Set,s=new Set,i=(o,l)=>{t.forEach(d=>{s.add(d.button),o.forEach(u=>{u.onMousePress&&u.onMousePress(d,l)})}),t.clear(),e.forEach(d=>{s.delete(d.button),o.forEach(u=>{u.onMouseRelease&&u.onMouseRelease(d,l)})}),e.clear(),w.forEach(d=>{g.add(d),o.forEach(u=>{u.onKeyPress&&u.onKeyPress(d,l)})}),w.clear(),y.forEach(d=>{g.delete(d),o.forEach(u=>{u.onKeyRelease&&u.onKeyRelease(d,l)})}),y.clear()},a={mouse:{canvasPos:new c(1e6,1e6),worldPos:new c(1e6,1e6),button:o=>s.has(o)},key:o=>g.has(o),__handleInput:i},h=o=>{const l=n.scale??1,d=n.element.getBoundingClientRect();return new c((o.clientX-d.left)/l,(o.clientY-d.right)/l)};document.addEventListener("mousedown",o=>{const l=h(o);t.add({button:o.button,canvasPos:l,worldPos:n.camera?n.camera.toWorldPosition(a.mouse.canvasPos):l})}),document.addEventListener("mouseup",o=>{const l=h(o);e.add({button:o.button,canvasPos:l,worldPos:n.camera?n.camera.toWorldPosition(a.mouse.canvasPos):l})});const _=o=>o.preventDefault();return document.addEventListener("mousemove",o=>{a.mouse.canvasPos=h(o),a.mouse.worldPos=n.camera?n.camera.toWorldPosition(a.mouse.canvasPos):a.mouse.canvasPos;const l=n.scale??1;a.mouse.canvasPos.isInside(new c(0,0),new c(n.element.width/l,n.element.height/l))?document.addEventListener("contextmenu",_):document.removeEventListener("contextmenu",_)}),a};class k{constructor(t){r(this,"__parentElement");r(this,"__canvasElement");r(this,"__ctx");r(this,"__scale",1);r(this,"camera");r(this,"drawImage",(t,e,s,i)=>{const a=Object.assign({imageSmoothingEnabled:!1},i);this.withStyleAndPos(a,h=>{t.image&&this.__ctx.drawImage(t.image,h.x,h.y,t.image.width*(s??1),t.image.height*(s??1))},e)});this.__parentElement=t,this.__canvasElement=document.createElement("canvas"),this.__canvasElement.classList.add("gameCanvas"),this.__parentElement.appendChild(this.__canvasElement),this.__ctx=this.__canvasElement.getContext("2d",{alpha:!1})}__getCameraPositionDelta(){var e,s;if(!((e=this.camera)!=null&&e.target))return new c(0,0);const t=this.camera.target.pos.minus(this.camera.posPrev);return this.camera.posPrev=(s=this.camera.target)==null?void 0:s.pos,t}setOptions(t){this.__canvasElement.width=t.width??this.__canvasElement.width,this.__canvasElement.height=t.height??this.__canvasElement.height,this.__scale=t.scale??this.__scale,t.scale&&this.__ctx.scale(t.scale,t.scale)}get element(){return this.__canvasElement}get scale(){return this.__scale}withStyle(t,e){this.__ctx.save(),t.strokeStyle!==void 0&&(this.__ctx.strokeStyle=t.strokeStyle),t.lineWidth!==void 0&&(this.__ctx.lineWidth=t.lineWidth),t.fillStyle!==void 0&&(this.__ctx.fillStyle=t.fillStyle),(t.font!==void 0||t.fontSize!==void 0)&&(this.__ctx.font=`${t.fontSize??8}px ${t.font??"arial"}`),t.imageSmoothingEnabled!=null&&(this.__ctx.imageSmoothingEnabled=t.imageSmoothingEnabled),e(),this.__ctx.restore()}withStyleAndPos(t,e,s){this.withStyle(t,()=>{this.camera&&!t.gui?e(this.camera.toCanvasPosition(s)):e(s)})}withStyleAndPositions(t,e,s){this.withStyle(t,()=>{this.camera&&!t.gui?e(s.map(i=>this.camera.toCanvasPosition(i))):e(s)})}drawRect(t,e,s){const i=Object.assign({fillStyle:"white"},s);this.withStyleAndPos(i,a=>{this.__ctx.fillStyle&&this.__ctx.fillRect(a.x,a.y,e.x,e.y),this.__ctx.strokeStyle&&this.__ctx.strokeRect(a.x,a.y,e.x,e.y)},t)}drawClear(){this.__ctx.clearRect(0,0,this.__canvasElement.width,this.__canvasElement.height)}drawPath(t,e){const s=Object.assign({strokeStyle:"white",lineWidth:1},e);this.withStyleAndPositions(s,i=>{this.__ctx.beginPath(),this.__ctx.moveTo(i[0].x,i[0].y);for(let a=0;a<i.length;a++)this.__ctx.lineTo(i[a].x,i[a].y);this.__ctx.stroke()},t)}drawLine(t,e,s,i){const a=t.copy(),h=e.copy(),_=Math.atan2(h.y-a.y,h.x-a.x);s.startOffset&&(a.x+=s.startOffset*Math.cos(_),a.y+=s.startOffset*Math.sin(_)),s.endOffset&&(h.x+=s.endOffset*Math.cos(_),h.y+=s.endOffset*Math.sin(_));const o=a.lengthTo(h);s.maxLength&&o>s.maxLength?(h.x=a.x+s.maxLength*Math.cos(_),h.y=a.y+s.maxLength*Math.sin(_)):s.minLength&&o<s.minLength&&(h.x=a.x+s.minLength*Math.cos(_),h.y=a.y+s.minLength*Math.sin(_)),this.drawPath([a,h],i)}drawText(t,e,s){const i=Object.assign({fillStyle:"white",font:"arial",fontSize:8},s);this.withStyleAndPos(i,a=>{this.__ctx.fillText(t,a.x,a.y+(i.fontSize??0))},e)}drawCircle(t,e,s){const i=Object.assign({fillStyle:"white"},s);this.withStyleAndPos(i,a=>{this.__ctx.beginPath(),this.__ctx.arc(a.x,a.y,t,0,2*Math.PI),this.__ctx.closePath(),this.__ctx.fillStyle&&this.__ctx.fill(),this.__ctx.strokeStyle&&this.__ctx.stroke()},e)}}class B{constructor(){r(this,"audioBuffers",new Map);r(this,"__context")}getContext(){return this.__context||(this.__context=new AudioContext),this.__context}async prefetch(t){const e=this.audioBuffers.get(t);if(e)return e;const s=await fetch(t).then(i=>i.arrayBuffer()).then(i=>this.getContext().decodeAudioData(i));return this.audioBuffers.set(t,s),s}async playAudioUrl(t){const e=this.audioBuffers.get(t)??await this.prefetch(t);this.playAudioBuffer(e)}async playAudioBuffer(t){const e=this.getContext(),s=e.createBufferSource();s.buffer=t,s.connect(e.destination),s.start()}}const I={width:480,height:320,scale:2,fps:60,zSort:!0,baseUrl:"./"};class R{constructor(t){r(this,"__gameDiv");r(this,"__assetsDiv");r(this,"__options",I);r(this,"__gameInstances",[]);r(this,"__canvas");r(this,"__t",0);r(this,"__input");r(this,"__currentFps",0);r(this,"__audioStore",new B);r(this,"beforeDraw");r(this,"afterDraw");r(this,"beforeStep");r(this,"afterStep");if(!t)throw new Error("Element passed to Game() is null!");if(!(t instanceof HTMLDivElement))throw new Error("Element passed to Game() is not an HTMLDivElement!");this.__gameDiv=t,this.__canvas=new k(this.__gameDiv),this.__assetsDiv=document.createElement("div"),this.__assetsDiv.hidden=!0,this.__gameDiv.appendChild(this.__assetsDiv),this.setOptions(I),this.__input=F(this.__canvas)}setOptions(t){this.__options={...this.__options,...t};const e=this.getCanvasSize().multiply(this.__options.scale);return this.__canvas.setOptions({width:e.x,height:e.y,scale:this.__options.scale}),this}get options(){return{...this.__options}}get canvas(){return this.__canvas}get currentFps(){return this.__currentFps}getCanvasSize(){return new c(this.__options.width,this.__options.height)}getInstances(t){return t?this.__gameInstances.filter(t):[...this.__gameInstances]}getInstancesOfClass(t){return this.getInstances(e=>e instanceof t)}__addObject(t){this.__gameInstances.push(t)}__removeObject(t){D(this.__gameInstances,t)}__addAssetElement(t){var e;(e=this.__assetsDiv)==null||e.appendChild(t)}play(){let t=0,e=0;const s=i=>{requestAnimationFrame(s);const a=i-t,h=1e3/this.__options.fps;a>=h&&(t=i-a%h,this.__currentFps=1e3/(i-e),e=i,this.__step())};s(0)}__maybeSort(){if(!this.__options.zSort)return;this.__gameInstances.some(e=>e.__changed)&&(this.__gameInstances.sort((e,s)=>e.__zIndex-s.__zIndex),this.__gameInstances.forEach(e=>e.__changed=!1))}getGameContext(){return{game:this,input:this.__input,audio:this.__audioStore,dtFactor:Math.round(this.__options.fps/this.currentFps),t:this.__t}}__step(){var s,i,a,h;const t={game:this,canvas:this.__canvas,input:this.__input,t:this.__t},e=this.getGameContext();this.__input.mouse.worldPos=this.__input.mouse.worldPos.plus(this.__canvas.__getCameraPositionDelta()),this.__maybeSort(),this.__input.__handleInput(this.__gameInstances,e),this.__canvas.drawClear(),(s=this.beforeDraw)==null||s.call(this,t),this.__gameInstances.forEach(_=>{var o;(o=_.draw)==null||o.call(_,t)}),(i=this.afterDraw)==null||i.call(this,t),(a=this.beforeStep)==null||a.call(this,e),this.__gameInstances.forEach(_=>{var o;(o=_.step)==null||o.call(_,e)}),(h=this.afterStep)==null||h.call(this,e),this.__t++}}class G{constructor(){r(this,"__changed",!0);r(this,"__zIndex",0);r(this,"__game");this.activate()}activate(t){var e;return t&&(this.deactivate(),this.__game=t),this.__game?(this.__game.__addObject(this),(e=this.onActivate)==null||e.call(this,this.__game.getGameContext()),this):this}deactivate(){var t;return this.__game?((t=this.onDeactivate)==null||t.call(this,this.__game.getGameContext()),this.__game.__removeObject(this),this):this}destruct(){var t;return this.deactivate(),this.__game?((t=this.onDestruct)==null||t.call(this,this.__game.getGameContext()),this):this}setZIndex(t){return this.__zIndex=t,this.__changed=!0,this}}class W{constructor(t){r(this,"size");r(this,"posPrev",new c(0,0));r(this,"target");this.size=t}setTarget(t){return this.target=t,this}toWorldPosition(t){return this.target?t.plus(this.target.pos).minus(this.size.half()):t}toCanvasPosition(t){return this.target?t.minus(this.target.pos).plus(this.size.half()):t}}class v extends G{constructor(e,s){super();r(this,"pos");this.pos=new c(e,s),this.setZIndex(s)}}const C=new Map;class q{}class J extends q{constructor(e,s){super();r(this,"__path");r(this,"__image");this.__path=e,s&&this.__load(s)}__load(e){const s=C.get(this.__path);s instanceof HTMLImageElement&&(this.__image=s);const i=new Image;i.src=this.__path,i.onload=()=>{C.set(this.__path,i),this.__image=i},e.__addAssetElement(i)}size(){var e,s;return new c(((e=this.__image)==null?void 0:e.width)??0,((s=this.__image)==null?void 0:s.height)??0)}get image(){return this.__image}}class O extends v{constructor(e,s,i){super(e,s);r(this,"image");this.image=new J(i)}activate(e){return super.activate(e),this.__game&&this.image.__load(this.__game),this}draw(e){e.canvas.drawImage(this.image,this.pos)}imageCenter(){return this.pos.plus(this.image.size().half())}}class S extends v{constructor(e,s,i,a={}){super(s,i);r(this,"getText");r(this,"drawStyle");this.getText=e,this.drawStyle=a}draw(e){e.canvas.drawText(this.getText(),this.pos,this.drawStyle)}}class L extends v{constructor(e,s){super(e.x,e.y);r(this,"direction");r(this,"speed",10);this.direction=e.direction(s),setTimeout(()=>this.destruct(),2e3)}draw(e){e.canvas.drawCircle(3,this.pos)}step(e){const s=e.game.getCanvasSize();(this.pos.x<0||s.x<this.pos.x)&&(this.direction.x*=-1),(this.pos.y<0||s.y<this.pos.y)&&(this.direction.y*=-1),this.pos=this.pos.plus(this.direction.multiply(this.speed*e.dtFactor))}}class f extends O{constructor(e,s){super(e,s,"./enemy.png");r(this,"target",new c(0,0))}onActivate(e){this.randomizeTarget(e)}step(e){this.pos=this.pos.moveTowards(this.target,1*e.dtFactor),this.setZIndex(this.pos.y+this.image.size().y),this.pos.lengthTo(this.target)<32&&this.randomizeTarget(e),e.game.getInstancesOfClass(L).forEach(i=>{i.pos.lengthTo(this.imageCenter())<this.image.size().x&&(e.audio.playAudioUrl(M.explosion),i.destruct(),new f(this.pos.x,this.pos.y).activate(e.game),new f(this.pos.x,this.pos.y).activate(e.game),this.destruct())})}randomizeTarget(e){const s=e.game.getCanvasSize();this.target=new c(E(0,s.x),E(0,s.y))}}class K extends O{constructor(t,e){super(t,e,"./player.png")}draw(t){t.canvas.drawLine(this.imageCenter(),t.input.mouse.worldPos,{startOffset:20,maxLength:20,minLength:20}),t.canvas.drawImage(this.image,this.pos)}step(t){const e=this.pos.copy();t.input.key("w")&&(e.y-=1),t.input.key("a")&&(e.x-=1),t.input.key("s")&&(e.y+=1),t.input.key("d")&&(e.x+=1),this.pos=this.pos.moveTowards(e,1.5*t.dtFactor),this.setZIndex(this.pos.y+this.image.size().y)}onMousePress(t,e){t.button==p.Left&&new L(this.imageCenter().moveTowards(t.worldPos,16),t.worldPos).activate(e.game)}}const $=document.querySelector("#game"),x={width:480,height:320,scale:4,fps:60},m=new R($).setOptions(x),b=new K(100,250).activate(m);m.canvas.camera=new W(new c(480,320)).setTarget(b);new f(200,200).activate(m);new S(()=>`Player: ${JSON.stringify(b.pos)}`,8,8).activate(m);new S(()=>`Objects: ${m.getInstances().length}`,8,24).activate(m);new S(()=>`FPS: ${m.currentFps.toFixed(1)}`,8,8,{gui:!0}).activate(m);m.beforeDraw=n=>{n.canvas.drawRect(new c(0,0),new c(x.width,x.height),{fillStyle:"",strokeStyle:"blue",lineWidth:1})};const M={explosion:"./explosion.wav"};Object.values(M).forEach(n=>m.getGameContext().audio.prefetch(n));m.play();
